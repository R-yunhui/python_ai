"""
LangChainå­¦ä¹  - Agentæ™ºèƒ½ä½“ï¼ˆå¤šå·¥å…·ä¸²è”ï¼‰

å­¦ä¹ ç›®æ ‡ï¼š
1. ç†è§£Agentçš„æ¦‚å¿µå’Œå·¥ä½œåŸç†
2. æŒæ¡å¦‚ä½•åˆ›å»ºæ”¯æŒå¤šå·¥å…·çš„Agent
3. å­¦ä¼šè®©AIè‡ªä¸»å†³ç­–å’Œè§„åˆ’ä»»åŠ¡
4. äº†è§£ReActï¼ˆæ¨ç†+è¡ŒåŠ¨ï¼‰æ¨¡å¼

å¯¹æ¯”Spring-AIï¼š
åœ¨Spring-AIä¸­è¿˜æ²¡æœ‰å®Œæ•´çš„Agentå®ç°ï¼Œé€šå¸¸éœ€è¦æ‰‹åŠ¨ç¼–æ’ï¼š
    1. ç¬¬ä¸€æ¬¡è°ƒç”¨AIåˆ¤æ–­éœ€è¦ä»€ä¹ˆå·¥å…·
    2. æ‰§è¡Œå·¥å…·
    3. ç¬¬äºŒæ¬¡è°ƒç”¨AIå¤„ç†ç»“æœ
    4. é‡å¤ç›´åˆ°å®Œæˆ
    
åœ¨LangChainä¸­ï¼ŒAgentä¼šè‡ªåŠ¨å®Œæˆè¿™ä¸ªå¾ªç¯è¿‡ç¨‹
"""

import os
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.tools import tool
from langchain.agents import create_tool_calling_agent, AgentExecutor
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from typing import Dict, List, Any
import json
from datetime import datetime, timedelta
import random

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()


# ============================================================================
# ä»€ä¹ˆæ˜¯Agentï¼Ÿ
# ============================================================================
"""
Agentï¼ˆæ™ºèƒ½ä½“ï¼‰= AI + Tools + å†³ç­–å¾ªç¯

æ™®é€šToolä½¿ç”¨ï¼š
ç”¨æˆ· -> AI -> è°ƒç”¨ä¸€ä¸ªTool -> è¿”å›ç»“æœ
(å•æ¬¡è°ƒç”¨ï¼Œéœ€è¦äººå·¥åˆ¤æ–­)

Agentæ™ºèƒ½ä½“ï¼š
ç”¨æˆ· -> Agent -> åˆ†æä»»åŠ¡ -> è°ƒç”¨Tool1 -> åˆ†æç»“æœ -> è°ƒç”¨Tool2 -> ç»¼åˆç»“æœ -> å›ç­”
(è‡ªåŠ¨å¾ªç¯ï¼ŒAIè‡ªä¸»å†³ç­–)

ReActæ¨¡å¼ï¼ˆReasoning + Actingï¼‰ï¼š
1. Thoughtï¼ˆæ€è€ƒï¼‰ï¼šæˆ‘éœ€è¦åšä»€ä¹ˆï¼Ÿ
2. Actionï¼ˆè¡ŒåŠ¨ï¼‰ï¼šè°ƒç”¨å“ªä¸ªå·¥å…·ï¼Ÿ
3. Observationï¼ˆè§‚å¯Ÿï¼‰ï¼šå·¥å…·è¿”å›äº†ä»€ä¹ˆï¼Ÿ
4. é‡å¤1-3ï¼Œç›´åˆ°å¾—åˆ°æœ€ç»ˆç­”æ¡ˆ

ç±»ä¼¼äºï¼š
- äººç±»è§£å†³é—®é¢˜çš„è¿‡ç¨‹
- é€’å½’å‡½æ•°è°ƒç”¨
- å·¥ä½œæµå¼•æ“
"""


# ============================================================================
# åœºæ™¯ï¼šæ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹
# åˆ›å»ºä¸€ç³»åˆ—å·¥å…·æ¥å¸®åŠ©ç”¨æˆ·è§„åˆ’æ—…è¡Œ
# ============================================================================

# æ¨¡æ‹Ÿæ•°æ®åº“
WEATHER_DATA = {
    "åŒ—äº¬": {"temp": 15, "condition": "æ™´å¤©", "humidity": 45},
    "ä¸Šæµ·": {"temp": 20, "condition": "å¤šäº‘", "humidity": 65},
    "å¹¿å·": {"temp": 28, "condition": "æ™´å¤©", "humidity": 80},
    "æˆéƒ½": {"temp": 18, "condition": "é˜´å¤©", "humidity": 70},
    "æ­å·": {"temp": 22, "condition": "å°é›¨", "humidity": 75},
}

ATTRACTIONS = {
    "åŒ—äº¬": [
        {"name": "æ•…å®«", "rating": 4.8, "price": 60, "time": "3å°æ—¶"},
        {"name": "é•¿åŸ", "rating": 4.9, "price": 40, "time": "5å°æ—¶"},
        {"name": "é¢å’Œå›­", "rating": 4.7, "price": 30, "time": "3å°æ—¶"}
    ],
    "ä¸Šæµ·": [
        {"name": "å¤–æ»©", "rating": 4.7, "price": 0, "time": "2å°æ—¶"},
        {"name": "ä¸œæ–¹æ˜ç ", "rating": 4.5, "price": 180, "time": "2å°æ—¶"},
        {"name": "è¿ªå£«å°¼", "rating": 4.8, "price": 499, "time": "å…¨å¤©"}
    ],
    "æ­å·": [
        {"name": "è¥¿æ¹–", "rating": 4.9, "price": 0, "time": "4å°æ—¶"},
        {"name": "çµéšå¯º", "rating": 4.6, "price": 45, "time": "2å°æ—¶"}
    ]
}

HOTELS = {
    "åŒ—äº¬": [
        {"name": "åŒ—äº¬é¥­åº—", "price": 800, "rating": 4.7, "location": "å¸‚ä¸­å¿ƒ"},
        {"name": "å¦‚å®¶å¿«æ·", "price": 300, "rating": 4.3, "location": "åœ°é“é™„è¿‘"},
        {"name": "æ±‰åº­é…’åº—", "price": 250, "rating": 4.2, "location": "å•†ä¸šåŒº"}
    ],
    "ä¸Šæµ·": [
        {"name": "å’Œå¹³é¥­åº—", "price": 1200, "rating": 4.8, "location": "å¤–æ»©"},
        {"name": "é”¦æ±Ÿä¹‹æ˜Ÿ", "price": 400, "rating": 4.4, "location": "äººæ°‘å¹¿åœº"}
    ],
    "æ­å·": [
        {"name": "è¥¿æ¹–å›½å®¾é¦†", "price": 1500, "rating": 4.9, "location": "è¥¿æ¹–è¾¹"},
        {"name": "ç»´ä¹Ÿçº³é…’åº—", "price": 350, "rating": 4.3, "location": "å¸‚ä¸­å¿ƒ"}
    ]
}

TRANSPORTATION = {
    ("åŒ—äº¬", "ä¸Šæµ·"): {"train": 553, "flight": 800, "duration_train": "5å°æ—¶", "duration_flight": "2å°æ—¶"},
    ("åŒ—äº¬", "æ­å·"): {"train": 490, "flight": 750, "duration_train": "6å°æ—¶", "duration_flight": "2å°æ—¶"},
    ("ä¸Šæµ·", "æ­å·"): {"train": 73, "flight": 450, "duration_train": "1å°æ—¶", "duration_flight": "1å°æ—¶"},
}


# ============================================================================
# å·¥å…·1ï¼šæŸ¥è¯¢å¤©æ°”
# ============================================================================
@tool
def get_weather(city: str) -> str:
    """
    æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯ã€‚å½“ç”¨æˆ·è¯¢é—®æŸåœ°å¤©æ°”ã€æ°”æ¸©ã€æ˜¯å¦ä¸‹é›¨æ—¶ä½¿ç”¨ã€‚
    
    å‚æ•°:
        city: åŸå¸‚åç§°ï¼Œå¦‚"åŒ—äº¬"ã€"ä¸Šæµ·"ç­‰
        
    è¿”å›:
        JSONæ ¼å¼çš„å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…å«æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€æ¹¿åº¦
    """
    weather = WEATHER_DATA.get(city)
    if weather:
        return json.dumps({
            "city": city,
            "temperature": weather["temp"],
            "condition": weather["condition"],
            "humidity": weather["humidity"]
        }, ensure_ascii=False)
    else:
        return json.dumps({"error": f"æœªæ‰¾åˆ°{city}çš„å¤©æ°”ä¿¡æ¯"}, ensure_ascii=False)


# ============================================================================
# å·¥å…·2ï¼šæŸ¥è¯¢æ™¯ç‚¹
# ============================================================================
@tool
def search_attractions(city: str, max_results: int = 5) -> str:
    """
    æœç´¢æŒ‡å®šåŸå¸‚çš„æ—…æ¸¸æ™¯ç‚¹ã€‚å½“ç”¨æˆ·è¯¢é—®æŸåœ°æœ‰ä»€ä¹ˆå¥½ç©çš„ã€æ™¯ç‚¹æ¨èæ—¶ä½¿ç”¨ã€‚
    
    å‚æ•°:
        city: åŸå¸‚åç§°
        max_results: æœ€å¤šè¿”å›å‡ ä¸ªæ™¯ç‚¹ï¼Œé»˜è®¤5ä¸ª
        
    è¿”å›:
        JSONæ ¼å¼çš„æ™¯ç‚¹åˆ—è¡¨ï¼ŒåŒ…å«åç§°ã€è¯„åˆ†ã€é—¨ç¥¨ä»·æ ¼ã€å»ºè®®æ¸¸ç©æ—¶é—´
    """
    attractions = ATTRACTIONS.get(city, [])
    if attractions:
        return json.dumps({
            "city": city,
            "attractions": attractions[:max_results]
        }, ensure_ascii=False, indent=2)
    else:
        return json.dumps({"error": f"æœªæ‰¾åˆ°{city}çš„æ™¯ç‚¹ä¿¡æ¯"}, ensure_ascii=False)


# ============================================================================
# å·¥å…·3ï¼šæŸ¥è¯¢é…’åº—
# ============================================================================
@tool
def search_hotels(city: str, max_price: int = 10000) -> str:
    """
    æœç´¢æŒ‡å®šåŸå¸‚çš„é…’åº—ã€‚å½“ç”¨æˆ·è¯¢é—®ä½å®¿ã€é…’åº—æ¨èæ—¶ä½¿ç”¨ã€‚
    
    å‚æ•°:
        city: åŸå¸‚åç§°
        max_price: æœ€é«˜ä»·æ ¼é¢„ç®—ï¼ˆå…ƒ/æ™šï¼‰ï¼Œé»˜è®¤10000
        
    è¿”å›:
        JSONæ ¼å¼çš„é…’åº—åˆ—è¡¨ï¼ŒåŒ…å«åç§°ã€ä»·æ ¼ã€è¯„åˆ†ã€ä½ç½®
    """
    hotels = HOTELS.get(city, [])
    if hotels:
        # ç­›é€‰ç¬¦åˆé¢„ç®—çš„é…’åº—
        filtered = [h for h in hotels if h["price"] <= max_price]
        return json.dumps({
            "city": city,
            "hotels": filtered,
            "count": len(filtered)
        }, ensure_ascii=False, indent=2)
    else:
        return json.dumps({"error": f"æœªæ‰¾åˆ°{city}çš„é…’åº—ä¿¡æ¯"}, ensure_ascii=False)


# ============================================================================
# å·¥å…·4ï¼šæŸ¥è¯¢äº¤é€š
# ============================================================================
@tool
def get_transportation(from_city: str, to_city: str) -> str:
    """
    æŸ¥è¯¢ä¸¤ä¸ªåŸå¸‚ä¹‹é—´çš„äº¤é€šæ–¹å¼ã€‚å½“ç”¨æˆ·è¯¢é—®å¦‚ä½•å»æŸåœ°ã€äº¤é€šæ–¹å¼æ—¶ä½¿ç”¨ã€‚
    
    å‚æ•°:
        from_city: å‡ºå‘åŸå¸‚
        to_city: ç›®çš„åœ°åŸå¸‚
        
    è¿”å›:
        JSONæ ¼å¼çš„äº¤é€šä¿¡æ¯ï¼ŒåŒ…å«ç«è½¦å’Œé£æœºçš„ä»·æ ¼ã€æ—¶é•¿
    """
    # å°è¯•æ­£å‘å’Œåå‘æŸ¥è¯¢
    key1 = (from_city, to_city)
    key2 = (to_city, from_city)
    
    trans = TRANSPORTATION.get(key1) or TRANSPORTATION.get(key2)
    if trans:
        return json.dumps({
            "from": from_city,
            "to": to_city,
            "options": {
                "train": {
                    "price": trans["train"],
                    "duration": trans["duration_train"]
                },
                "flight": {
                    "price": trans["flight"],
                    "duration": trans["duration_flight"]
                }
            }
        }, ensure_ascii=False, indent=2)
    else:
        return json.dumps({
            "error": f"æœªæ‰¾åˆ°ä»{from_city}åˆ°{to_city}çš„äº¤é€šä¿¡æ¯"
        }, ensure_ascii=False)


# ============================================================================
# å·¥å…·5ï¼šè®¡ç®—æ—…è¡Œé¢„ç®—
# ============================================================================
@tool
def calculate_budget(
    accommodation: int,
    transportation: int,
    attractions: int,
    days: int
) -> str:
    """
    è®¡ç®—æ—…è¡Œæ€»é¢„ç®—ã€‚å½“ç”¨æˆ·è¯¢é—®è´¹ç”¨ã€é¢„ç®—æ—¶ä½¿ç”¨ã€‚
    
    å‚æ•°:
        accommodation: æ¯æ™šä½å®¿è´¹ç”¨ï¼ˆå…ƒï¼‰
        transportation: å¾€è¿”äº¤é€šè´¹ç”¨ï¼ˆå…ƒï¼‰
        attractions: æ™¯ç‚¹é—¨ç¥¨æ€»è´¹ç”¨ï¼ˆå…ƒï¼‰
        days: æ—…è¡Œå¤©æ•°
        
    è¿”å›:
        JSONæ ¼å¼çš„é¢„ç®—æ˜ç»†
    """
    # ä¼°ç®—é¤é¥®è´¹ç”¨ï¼ˆæ¯å¤©150å…ƒï¼‰
    food_cost = 150 * days
    
    # ä¼°ç®—å…¶ä»–è´¹ç”¨ï¼ˆæ€»è´¹ç”¨çš„10%ï¼‰
    subtotal = accommodation * days + transportation + attractions + food_cost
    other_cost = subtotal * 0.1
    
    total = subtotal + other_cost
    
    return json.dumps({
        "breakdown": {
            "accommodation": accommodation * days,
            "transportation": transportation,
            "attractions": attractions,
            "food": food_cost,
            "other": round(other_cost, 2)
        },
        "total": round(total, 2),
        "days": days
    }, ensure_ascii=False, indent=2)


# ============================================================================
# ç¤ºä¾‹1ï¼šåˆ›å»ºåŸºç¡€Agent
# ============================================================================
def example1_basic_agent():
    """
    æ¼”ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„Agent
    Agentä¼šè‡ªä¸»å†³ç­–ä½¿ç”¨å“ªäº›å·¥å…·
    """
    print("\n" + "=" * 60)
    print("ç¤ºä¾‹1ï¼šåŸºç¡€Agent - å•æ¬¡æŸ¥è¯¢")
    print("=" * 60)
    
    # 1. å‡†å¤‡å·¥å…·åˆ—è¡¨
    tools: List[Any] = [
        get_weather,
        search_attractions,
        search_hotels,
        get_transportation,
        calculate_budget
    ]
    
    # 2. åˆ›å»ºæç¤ºè¯æ¨¡æ¿
    prompt = ChatPromptTemplate.from_messages([
        ("system", """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—…è¡Œè§„åˆ’åŠ©æ‰‹ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·æ¥å¸®åŠ©ç”¨æˆ·è§„åˆ’æ—…è¡Œï¼š

- get_weather: æŸ¥è¯¢å¤©æ°”
- search_attractions: æœç´¢æ™¯ç‚¹
- search_hotels: æœç´¢é…’åº—
- get_transportation: æŸ¥è¯¢äº¤é€š
- calculate_budget: è®¡ç®—é¢„ç®—

è¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ï¼Œåˆç†ä½¿ç”¨å·¥å…·ï¼Œæä¾›è¯¦ç»†çš„æ—…è¡Œå»ºè®®ã€‚
æ³¨æ„ï¼š
1. å…ˆç†è§£ç”¨æˆ·éœ€æ±‚
2. é€‰æ‹©åˆé€‚çš„å·¥å…·
3. ç»¼åˆä¿¡æ¯ç»™å‡ºå»ºè®®
"""),
        ("human", "{input}"),
        MessagesPlaceholder(variable_name="agent_scratchpad"),
    ])
    
    # 3. åˆå§‹åŒ–æ¨¡å‹
    llm = ChatOpenAI(
        model=os.getenv("OPENAI_MODEL", "gpt-3.5-turbo"),
        temperature=0,
        api_key=os.getenv("OPENAI_API_KEY"),
        base_url=os.getenv("OPENAI_API_BASE", "https://api.openai.com/v1")
    )
    
    # 4. åˆ›å»ºAgent
    agent = create_tool_calling_agent(llm, tools, prompt)
    
    # 5. åˆ›å»ºAgentæ‰§è¡Œå™¨
    agent_executor = AgentExecutor(
        agent=agent,
        tools=tools,
        verbose=True,  # æ˜¾ç¤ºè¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹
        max_iterations=5  # æœ€å¤šæ‰§è¡Œ5è½®
    )
    
    # 6. æµ‹è¯•ç®€å•é—®é¢˜
    question = "åŒ—äº¬ç°åœ¨å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
    
    print(f"\nç”¨æˆ·é—®é¢˜: {question}\n")
    print("=" * 60)
    
    result = agent_executor.invoke({"input": question})
    
    print("\n" + "=" * 60)
    print(f"\næœ€ç»ˆç­”æ¡ˆ: {result['output']}\n")


# ============================================================================
# ç¤ºä¾‹2ï¼šå¤æ‚ä»»åŠ¡ - å¤šå·¥å…·ä¸²è”
# ============================================================================
def example2_complex_task():
    """
    æ¼”ç¤ºAgentå¦‚ä½•å¤„ç†å¤æ‚ä»»åŠ¡
    éœ€è¦è°ƒç”¨å¤šä¸ªå·¥å…·å¹¶ç»¼åˆä¿¡æ¯
    """
    print("\n" + "=" * 60)
    print("ç¤ºä¾‹2ï¼šå¤æ‚ä»»åŠ¡ - å¤šå·¥å…·ä¸²è”")
    print("=" * 60)
    
    # å‡†å¤‡å·¥å…·
    tools: List[Any] = [
        get_weather,
        search_attractions,
        search_hotels,
        get_transportation,
        calculate_budget
    ]
    
    # åˆ›å»ºæç¤ºè¯
    prompt = ChatPromptTemplate.from_messages([
        ("system", """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—…è¡Œè§„åˆ’åŠ©æ‰‹ã€‚

ä½ çš„å·¥ä½œæµç¨‹ï¼š
1. ç†è§£ç”¨æˆ·çš„æ—…è¡Œéœ€æ±‚ï¼ˆç›®çš„åœ°ã€å¤©æ•°ã€é¢„ç®—ç­‰ï¼‰
2. æŸ¥è¯¢ç›®çš„åœ°çš„å¤©æ°”çŠ¶å†µ
3. æ¨èåˆé€‚çš„æ™¯ç‚¹
4. æ¨èåˆé€‚çš„é…’åº—ï¼ˆè€ƒè™‘é¢„ç®—ï¼‰
5. å¦‚æœæ¶‰åŠå¤šä¸ªåŸå¸‚ï¼ŒæŸ¥è¯¢äº¤é€šæ–¹å¼
6. è®¡ç®—æ€»ä½“é¢„ç®—
7. ç»¼åˆä»¥ä¸Šä¿¡æ¯ï¼Œç»™å‡ºè¯¦ç»†çš„æ—…è¡Œå»ºè®®

è¯·æŒ‰æ­¥éª¤æ€è€ƒï¼Œåˆç†ä½¿ç”¨å·¥å…·ï¼Œç»™å‡ºä¸“ä¸šå»ºè®®ã€‚
"""),
        ("human", "{input}"),
        MessagesPlaceholder(variable_name="agent_scratchpad"),
    ])
    
    # åˆå§‹åŒ–æ¨¡å‹å’ŒAgent
    llm = ChatOpenAI(
        model=os.getenv("OPENAI_MODEL", "gpt-3.5-turbo"),
        temperature=0.3,
        api_key=os.getenv("OPENAI_API_KEY"),
        base_url=os.getenv("OPENAI_API_BASE", "https://api.openai.com/v1")
    )
    
    agent = create_tool_calling_agent(llm, tools, prompt)
    agent_executor = AgentExecutor(
        agent=agent,
        tools=tools,
        verbose=True,
        max_iterations=10  # å¤æ‚ä»»åŠ¡å¯èƒ½éœ€è¦æ›´å¤šè½®æ¬¡
    )
    
    # æµ‹è¯•å¤æ‚é—®é¢˜
    question = """æˆ‘æƒ³å»æ­å·æ—…æ¸¸3å¤©ï¼Œé¢„ç®—åœ¨3000å…ƒå·¦å³ã€‚
èƒ½å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å—ï¼ŸåŒ…æ‹¬æ™¯ç‚¹æ¨èã€ä½å®¿å»ºè®®å’Œå¤§æ¦‚è´¹ç”¨ã€‚"""
    
    print(f"\nç”¨æˆ·é—®é¢˜:\n{question}\n")
    print("=" * 60)
    
    result = agent_executor.invoke({"input": question})
    
    print("\n" + "=" * 60)
    print(f"\næœ€ç»ˆç­”æ¡ˆ:\n{result['output']}\n")


# ============================================================================
# ç¤ºä¾‹3ï¼šå¤šåŸå¸‚æ—…è¡Œè§„åˆ’
# ============================================================================
def example3_multi_city_planning():
    """
    æ¼”ç¤ºæœ€å¤æ‚çš„åœºæ™¯ï¼šå¤šåŸå¸‚æ—…è¡Œè§„åˆ’
    éœ€è¦æŸ¥è¯¢å¤©æ°”ã€æ™¯ç‚¹ã€é…’åº—ã€äº¤é€šï¼Œå¹¶è®¡ç®—æ€»é¢„ç®—
    """
    print("\n" + "=" * 60)
    print("ç¤ºä¾‹3ï¼šå¤šåŸå¸‚æ—…è¡Œè§„åˆ’")
    print("=" * 60)
    
    # å‡†å¤‡å·¥å…·
    tools: List[Any] = [
        get_weather,
        search_attractions,
        search_hotels,
        get_transportation,
        calculate_budget
    ]
    
    # åˆ›å»ºæç¤ºè¯
    prompt = ChatPromptTemplate.from_messages([
        ("system", """ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„æ—…è¡Œè§„åˆ’å¸ˆã€‚

å¤šåŸå¸‚æ—…è¡Œè§„åˆ’æ­¥éª¤ï¼š
1. äº†è§£æ¯ä¸ªç›®çš„åœ°çš„åŸºæœ¬æƒ…å†µï¼ˆå¤©æ°”ã€æ™¯ç‚¹ï¼‰
2. è§„åˆ’åŸå¸‚é—´çš„äº¤é€šè·¯çº¿
3. ä¸ºæ¯ä¸ªåŸå¸‚æ¨èä½å®¿
4. è®¡ç®—æ¯ä¸ªåŸå¸‚çš„èŠ±è´¹
5. æ±‡æ€»æ€»é¢„ç®—
6. ç»™å‡ºåˆç†çš„è¡Œç¨‹å®‰æ’å»ºè®®

è¯·ç»†è‡´å‘¨åˆ°åœ°å¸®åŠ©ç”¨æˆ·è§„åˆ’æ—…è¡Œã€‚
"""),
        ("human", "{input}"),
        MessagesPlaceholder(variable_name="agent_scratchpad"),
    ])
    
    # åˆå§‹åŒ–
    llm = ChatOpenAI(
        model=os.getenv("OPENAI_MODEL", "gpt-3.5-turbo"),
        temperature=0.3,
        api_key=os.getenv("OPENAI_API_KEY"),
        base_url=os.getenv("OPENAI_API_BASE", "https://api.openai.com/v1")
    )
    
    agent = create_tool_calling_agent(llm, tools, prompt)
    agent_executor = AgentExecutor(
        agent=agent,
        tools=tools,
        verbose=True,
        max_iterations=15  # å¤šåŸå¸‚éœ€è¦æ›´å¤šè½®æ¬¡
    )
    
    # æµ‹è¯•å¤šåŸå¸‚é—®é¢˜
    question = """æˆ‘æƒ³ä»åŒ—äº¬å‡ºå‘ï¼Œå…ˆå»ä¸Šæµ·ç©2å¤©ï¼Œå†å»æ­å·ç©2å¤©ã€‚
è¯·å¸®æˆ‘è§„åˆ’è¡Œç¨‹ï¼ŒåŒ…æ‹¬ï¼š
1. æ¯ä¸ªåŸå¸‚çš„å¤©æ°”å’Œæ™¯ç‚¹æ¨è
2. åŸå¸‚é—´çš„äº¤é€šæ–¹å¼
3. ä½å®¿å»ºè®®ï¼ˆé¢„ç®—æ¯æ™š500å…ƒå·¦å³ï¼‰
4. æ€»è´¹ç”¨é¢„ä¼°"""
    
    print(f"\nç”¨æˆ·é—®é¢˜:\n{question}\n")
    print("=" * 60)
    
    result = agent_executor.invoke({"input": question})
    
    print("\n" + "=" * 60)
    print(f"\næœ€ç»ˆç­”æ¡ˆ:\n{result['output']}\n")


# ============================================================================
# Agentå·¥ä½œåŸç†è§£æ
# ============================================================================
def explain_agent_workflow():
    """
    è§£é‡ŠAgentçš„å·¥ä½œåŸç†
    """
    print("\n" + "=" * 60)
    print("Agentå·¥ä½œåŸç†è¯¦è§£")
    print("=" * 60)
    
    print("""
Agentæ‰§è¡Œæµç¨‹ï¼ˆReActæ¨¡å¼ï¼‰ï¼š

ç¬¬1è½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thoughtï¼ˆæ€è€ƒï¼‰                             â”‚
â”‚ ç”¨æˆ·æƒ³å»æ­å·æ—…æ¸¸ï¼Œæˆ‘éœ€è¦å…ˆäº†è§£å¤©æ°”æƒ…å†µ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Actionï¼ˆè¡ŒåŠ¨ï¼‰                              â”‚
â”‚ è°ƒç”¨å·¥å…·: get_weather(city="æ­å·")         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Observationï¼ˆè§‚å¯Ÿï¼‰                         â”‚
â”‚ æ­å·å¤©æ°”ï¼š22åº¦ï¼Œå°é›¨ï¼Œæ¹¿åº¦75%               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬2è½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thought                                     â”‚
â”‚ å¤©æ°”è¿˜ä¸é”™ï¼Œæ¥ä¸‹æ¥æŸ¥è¯¢æ™¯ç‚¹æ¨è             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Action                                      â”‚
â”‚ è°ƒç”¨å·¥å…·: search_attractions(city="æ­å·")  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Observation                                 â”‚
â”‚ è¥¿æ¹–(4.9åˆ†,å…è´¹)ã€çµéšå¯º(4.6åˆ†,45å…ƒ)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

... ç»§ç»­å¾ªç¯ï¼Œç›´åˆ°æ”¶é›†è¶³å¤Ÿä¿¡æ¯ ...

æœ€ç»ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Final Answerï¼ˆæœ€ç»ˆç­”æ¡ˆï¼‰                    â”‚
â”‚ ç»¼åˆä»¥ä¸Šä¿¡æ¯ï¼Œç»™å‡ºå®Œæ•´çš„æ—…è¡Œå»ºè®®           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç‰¹ç‚¹ï¼š
âœ… è‡ªä¸»å†³ç­–ï¼šAIè‡ªå·±åˆ¤æ–­éœ€è¦è°ƒç”¨å“ªäº›å·¥å…·
âœ… å¾ªç¯æ‰§è¡Œï¼šæ ¹æ®ç»“æœå†³å®šæ˜¯å¦éœ€è¦æ›´å¤šä¿¡æ¯
âœ… çµæ´»ç»„åˆï¼šå¯ä»¥ä»»æ„ç»„åˆå¤šä¸ªå·¥å…·
âœ… æ¨ç†èƒ½åŠ›ï¼šä¸åªæ˜¯æ‰§è¡Œï¼Œè¿˜è¦æ€è€ƒå’Œè§„åˆ’

å¯¹æ¯”Spring-AIï¼š
Spring-AIç›®å‰éœ€è¦æ‰‹åŠ¨ç¼–æ’è¿™ä¸ªæµç¨‹ï¼š
1. æ‰‹åŠ¨åˆ¤æ–­éœ€è¦ä»€ä¹ˆä¿¡æ¯
2. æ‰‹åŠ¨è°ƒç”¨ç›¸åº”çš„å‡½æ•°
3. æ‰‹åŠ¨å°†ç»“æœä¼ ç»™AI
4. æ‰‹åŠ¨å†³å®šæ˜¯å¦ç»§ç»­

LangChainçš„Agentè‡ªåŠ¨å®Œæˆæ‰€æœ‰è¿™äº›æ­¥éª¤ï¼
    """)


# ============================================================================
# ä¸»å‡½æ•°
# ============================================================================
def main():
    """
    ä¸»å‡½æ•°ï¼šè¿è¡Œæ‰€æœ‰ç¤ºä¾‹
    """
    print("ğŸš€ å¼€å§‹å­¦ä¹ LangChain Agentæ™ºèƒ½ä½“")
    print("=" * 60)
    
    try:
        # æ£€æŸ¥APIå¯†é’¥
        if not os.getenv("OPENAI_API_KEY"):
            print("âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°OPENAI_API_KEY")
            print("è¯·å…ˆåœ¨.envæ–‡ä»¶ä¸­é…ç½®APIå¯†é’¥")
            return
        
        print("""
Agentï¼ˆæ™ºèƒ½ä½“ï¼‰æ˜¯LangChainæœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€ï¼
å®ƒèƒ½è®©AIè‡ªä¸»å†³ç­–ã€è§„åˆ’ä»»åŠ¡ã€ä¸²è”ä½¿ç”¨å¤šä¸ªå·¥å…·ã€‚

æœ¬ç¤ºä¾‹å°†å±•ç¤ºï¼š
âœ… åŸºç¡€Agentçš„åˆ›å»ºå’Œä½¿ç”¨
âœ… å¤æ‚ä»»åŠ¡çš„è‡ªåŠ¨åˆ†è§£
âœ… å¤šå·¥å…·çš„æ™ºèƒ½ä¸²è”
âœ… ReActæ¨ç†æ¨¡å¼

æç¤ºï¼šè®¾ç½®äº†verbose=Trueï¼Œä½ å¯ä»¥çœ‹åˆ°Agentçš„å®Œæ•´æ€è€ƒè¿‡ç¨‹ï¼
        """)
        
        input("\næŒ‰å›è½¦é”®å¼€å§‹ç¤ºä¾‹1...")
        example1_basic_agent()
        
        input("\næŒ‰å›è½¦é”®å¼€å§‹ç¤ºä¾‹2...")
        example2_complex_task()
        
        input("\næŒ‰å›è½¦é”®å¼€å§‹ç¤ºä¾‹3...")
        example3_multi_city_planning()
        
        # åŸç†è§£é‡Š
        explain_agent_workflow()
        
        # æ€»ç»“
        print("\n" + "=" * 60)
        print("âœ… æ­å–œï¼ä½ å·²ç»æŒæ¡äº†Agentæ™ºèƒ½ä½“çš„ä½¿ç”¨")
        print("=" * 60)
        print("""
å…³é”®æ¦‚å¿µå›é¡¾ï¼š

1. Agentæ ¸å¿ƒç»„ä»¶
   - Tools: å·¥å…·é›†åˆ
   - LLM: å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¤§è„‘ï¼‰
   - Prompt: æŒ‡å¯¼æ€ç»´çš„æç¤ºè¯
   - AgentExecutor: æ‰§è¡Œå™¨
   
2. ReActæ¨¡å¼
   - Thought: AIçš„æ€è€ƒè¿‡ç¨‹
   - Action: å†³å®šè°ƒç”¨å“ªä¸ªå·¥å…·
   - Observation: è§‚å¯Ÿå·¥å…·è¿”å›ç»“æœ
   - å¾ªç¯ç›´åˆ°å®Œæˆä»»åŠ¡
   
3. Agentç±»å‹
   - Tool Calling Agent: ä½¿ç”¨å·¥å…·è°ƒç”¨ï¼ˆæ¨èï¼‰
   - ReAct Agent: ä¼ ç»ŸReActæ¨¡å¼
   - Plan-and-Execute: è§„åˆ’æ‰§è¡Œå‹
   
4. ä½¿ç”¨åœºæ™¯
   - å¤æ‚ä»»åŠ¡è‡ªåŠ¨åˆ†è§£
   - å¤šæ­¥éª¤ä¿¡æ¯æŸ¥è¯¢
   - å·¥ä½œæµè‡ªåŠ¨åŒ–
   - æ™ºèƒ½åŠ©æ‰‹å¼€å‘

å¯¹æ¯”Spring-AIï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŠŸèƒ½             â”‚ Spring-AI              â”‚ LangChain Agent      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¥å…·è°ƒç”¨         â”‚ FunctionCallback       â”‚ @tool + bind_tools   â”‚
â”‚ ä»»åŠ¡ç¼–æ’         â”‚ æ‰‹åŠ¨ç¼–æ’               â”‚ Agentè‡ªåŠ¨ç¼–æ’        â”‚
â”‚ å†³ç­–èƒ½åŠ›         â”‚ éœ€è¦äººå·¥åˆ¤æ–­           â”‚ AIè‡ªä¸»å†³ç­–           â”‚
â”‚ å¾ªç¯æ‰§è¡Œ         â”‚ æ‰‹åŠ¨å®ç°å¾ªç¯           â”‚ AgentExecutorè‡ªåŠ¨    â”‚
â”‚ æ¨ç†è¿‡ç¨‹         â”‚ ä¸å¯è§                 â”‚ verboseå¯æŸ¥çœ‹        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…åº”ç”¨ï¼š
âœ… æ™ºèƒ½å®¢æœï¼ˆè‡ªåŠ¨æŸ¥è¯¢å¤šä¸ªç³»ç»Ÿï¼‰
âœ… æ•°æ®åˆ†æï¼ˆè‡ªåŠ¨è°ƒç”¨å¤šä¸ªæŸ¥è¯¢ï¼‰
âœ… ä»»åŠ¡è‡ªåŠ¨åŒ–ï¼ˆè‡ªåŠ¨æ‰§è¡Œå¤šæ­¥éª¤ï¼‰
âœ… ç ”ç©¶åŠ©æ‰‹ï¼ˆè‡ªåŠ¨æœç´¢å’Œæ€»ç»“ï¼‰
âœ… ä»£ç åŠ©æ‰‹ï¼ˆè‡ªåŠ¨æŸ¥æ–‡æ¡£ã€å†™ä»£ç ã€æµ‹è¯•ï¼‰

æ³¨æ„äº‹é¡¹ï¼š
âš ï¸ è®¾ç½®max_iterationsé˜²æ­¢æ— é™å¾ªç¯
âš ï¸ å·¥å…·çš„æè¿°è¦æ¸…æ™°å‡†ç¡®
âš ï¸ å¤æ‚ä»»åŠ¡å¯èƒ½æ¶ˆè€—è¾ƒå¤štoken
âš ï¸ éœ€è¦æ¨¡å‹æ”¯æŒfunction callingï¼ˆå¦‚GPT-3.5/4ï¼‰

ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š
- RAGæ£€ç´¢å¢å¼º - æ„å»ºçŸ¥è¯†åº“é—®ç­”
- è‡ªå®šä¹‰Agent - å®ç°ç‰¹å®šä¸šåŠ¡é€»è¾‘
- Agentåä½œ - å¤šä¸ªAgentååŒå·¥ä½œ

ç»§ç»­åŠ æ²¹ï¼ğŸš€
        """)
        
    except Exception as e:
        print(f"\nâŒ è¿è¡Œå‡ºé”™: {e}")
        import traceback
        traceback.print_exc()


# ============================================================================
# ç¨‹åºå…¥å£
# ============================================================================
if __name__ == "__main__":
    main()

